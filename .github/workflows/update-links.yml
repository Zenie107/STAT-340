name: Update README Links
on:
  push:
    paths:
      - '**/*.html'
      - '.github/workflows/update-links.yml'

jobs:
  build:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Generate Links and Update README
        shell: python
        run: |
          import os

          user = "${{ github.repository }}".split('/')[0]
          repo = "${{ github.repository }}".split('/')[1]
          start_marker = ""
          end_marker = ""
          
          # 1. Gather all HTML links
          html_links = ["\n### ðŸ”— Project Links\n"]
          for root, dirs, files in os.walk("."):
              if ".github" in root or ".git" in root: continue
              for file in sorted(files):
                  if file.endswith(".html") and file != "index.html":
                      path = os.path.join(root, file).replace("./", "")
                      url = f"https://{user}.github.io/{repo}/{path}"
                      html_links.append(f"* [{path}]({url})\n")

          # 2. Read README
          if not os.path.exists("README.md"):
              with open("README.md", "w") as f: f.write("# " + repo + "\n")
          
          with open("README.md", "r") as f:
              content = f.read()

          # 3. Ensure markers exist; if not, append them
          if start_marker not in content:
              content += f"\n\n{start_marker}\n{end_marker}\n"

          # 4. Inject the links
          start_idx = content.index(start_marker) + len(start_marker)
          end_idx = content.index(end_marker)
          
          new_content = (
              content[:start_idx] + 
              "\n" + "".join(html_links) + 
              content[end_idx:]
          )

          with open("README.md", "w") as f:
              f.write(new_content)

      - name: Commit and Push
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          git add README.md
          git diff --quiet && git diff --staged --quiet || (git commit -m "docs: auto-update navigation links" && git push)
